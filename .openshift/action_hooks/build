#!/bin/bash
echo Build the cookbook
cp -r $OPENSHIFT_REPO_DIR/conf/envs/prod/openshift/config $OPENSHIFT_REPO_DIR/config


export COMPOSER_HOME="$OPENSHIFT_DATA_DIR/.composer"
if [ ! -f "$OPENSHIFT_DATA_DIR/composer.phar" ]; then
    echo Installing composer...
    curl -s https://getcomposer.org/installer -o $OPENSHIFT_DATA_DIR/composer_install.php
    php $OPENSHIFT_DATA_DIR/composer_install.php --install-dir=$OPENSHIFT_DATA_DIR
else
    echo Self-Update composer...
    php $OPENSHIFT_DATA_DIR/composer.phar self-update
fi


echo Retrieving dependencies with composer...
cd $OPENSHIFT_REPO_DIR ; 
php $OPENSHIFT_DATA_DIR/composer.phar install 

echo Setup sources and build deploy
./vendor/bin/phing -v
export env="prod"
./vendor/bin/phing setupProd
php $OPENSHIFT_DATA_DIR/composer.phar dump-autoload
./vendor/bin/phing buildDeploy
cp -r $OPENSHIFT_REPO_DIR/build/www $OPENSHIFT_REPO_DIR/www
./vendor/bin/phing clean